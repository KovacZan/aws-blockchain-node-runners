---
version: "3"
services:
  erigon_node:
    image: thorax/erigon:2.57.0-__IMAGE_ARCH__
    container_name: execution
    restart: always
    command:
      [
        "--chain=__CHAIN__",
        "--torrent.download.rate=1gb",
        "--datadir=/var/lib/erigon/data",
        "--authrpc.addr=0.0.0.0",
        "--authrpc.jwtsecret=/var/lib/erigon/secrets/jwtsecret",
        "--authrpc.vhosts=*",
        "--http",
        "--http.api=eth,debug,net,trace,web3,erigon",
        "--http.addr=0.0.0.0",
        "--http.vhosts=*",
        "--metrics",
        "--metrics.addr=0.0.0.0",
        "--ws",
        "--maxpeers=20"
      ]
    read_only: true
    volumes:
      - /data/polygon/erigon:/var/lib/erigon/data:rw
    stop_signal: SIGTERM
    stop_grace_period: 5m
    security_opt:
      - no-new-privileges:true
    read_only: true
    depends_on:
      - heimdallrest
    networks:
      - polygon
    ports:
      # Map the p2p port(30303), RPC HTTP port(8545), and engine port (8551)
      - "6060:6060"
      - "8545:8545"
      - "8546:8546"
      - "8551:8551"
      - "9093:9093"
      - "9094:9094"
      - "30303:30303/tcp"
      - "30303:30303/udp"

  heimdall:
    container_name: heimdall
    image: 0xpolygon/heimdall:1.0.3
    restart: unless-stopped
    ports:
      - '26657:26657'
      - '26656:26656'
    entrypoint: /usr/bin/heimdalld
    volumes:
      - /data/polygon/heimdall:/heimdall-home:rw
    command: start --home=/heimdall-home
    security_opt:
      - no-new-privileges:true
    read_only: true
    networks:
      - polygon

  heimdallrest:
    depends_on:
      - heimdall
    container_name: heimdallrest
    image: 0xpolygon/heimdall:1.0.3
    command: rest-server --home=/heimdall-home --node "tcp://heimdall:26657"
    ports:
      - 1317:1317
    volumes:
      - /data/polygon/heimdall:/heimdall-home:rw
    security_opt:
      - no-new-privileges:true
    read_only: true
    networks:
      - polygon
    restart: unless-stopped
